<script>
(function(){
    class LDPRoute extends HTMLElement {
        get name() {
            return this.getAttribute('name');
        }
        set name(name) {
            this.setAttribute('name', name);
        }
        connectedCallback() {
            this.addEventListener('click', function(event) {
                this.closest('ldp-router').navigate(this.name);
            }.bind(this));
        }
    }
    
    class LDPRouter extends HTMLElement {
        constructor() {
            super();
            window.addEventListener('popstate', event => this.display());
            window.addEventListener('navigate', event => this.navigate(event.detail.route, event.detail.resource));
            if(document.readyState=="complete") window.addEventListener('WebComponentsReady', event => this.display());
            else document.addEventListener("DOMContentLoaded", event => this.display());
        }
        get useHash() {
            return this.hasAttribute('use-hash');
        }
        get prefix() {
            if(this.hasAttribute('route-prefix'))
                return this.getAttribute('route-prefix') + '/';
            else
                return '';
        }
        get defaultRoute() {
            return this.getAttribute('default-route') || '';
        }
        get currentRoute() {
            const url = (this.useHash ? location.hash : location.pathname).slice(1);
            if(url.startsWith(this.prefix))
                return url.slice(this.prefix.length);
            else
                return null;
        }
        display(name) {
            name = name || this.currentRoute || this.defaultRoute;
            for(let route of this.querySelectorAll('ldp-route')) {
                const view = document.getElementById(route.name);
                if(view) {
                    if(name.split('/')[0] == route.name) {
                        view.style.display = 'block';
                        route.setAttribute('active', '');
                        //handle resource id
                        if(route.hasAttribute('id-prefix') && name.split('/')[1]) {
                            const id = route.getAttribute('id-prefix') + name.split('/')[1];
                            if(view.hasAttribute('bind-resources'))
                                view.setAttribute('data-src', id);
                            for(let element of view.querySelectorAll('[bind-resources]'))
                                element.setAttribute('data-src', id);
                        }
                    
                    } else {
                        view.style.display = 'none';
                        route.removeAttribute('active');

                        // Reseting all routers within the selected view
                        for(let router of view.querySelectorAll('ldp-router'))
                            router.display();
                    }
                }
            }
        }
        navigate(name, resource) {
            name = name || '';// of the route
            let id='', url = this.prefix + name;
            const route = this.querySelector('ldp-route[name='+name+']');
            if(!route) return; //this route is not for me!
            
            //if there is a resource, add its id to the url
            if(resource && route.hasAttribute('id-prefix'))
                id = '/' + resource['@id'].replace(route.getAttribute('id-prefix'), '');
            
            if(this.useHash)
                window.location.hash = url + id;
            else
                history.pushState({}, name, '/' + url + id);
            
            this.display(name + id);
        }
    }
    
    customElements.define('ldp-router', LDPRouter);
    customElements.define('ldp-route', LDPRoute);
}());
</script>
