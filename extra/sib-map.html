<link rel="import" href="../sib-base.html">
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
    integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
    crossorigin=""></script>
<script>
(function(){
    class SIBMap extends SIBListMixin(SIBBase) {
        get extra_context() {return {geo: "http://www.w3.org/2003/01/geo/wgs84_pos#", lat: "geo:lat", lng: "geo:long"}}
        constructor() {
            super();
            this.markers = [];
            this.attachShadow({mode: 'open'});
            const style = document.createElement('style');
            style.innerHTML = '@import url("https://unpkg.com/leaflet@1.3.1/dist/leaflet.css");';
            this.shadowRoot.appendChild(style);
            const div = document.createElement('div');
            div.style = "width: 100%; height: 100%";
            this.map = L.map(div);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}').addTo(this.map);
            this.shadowRoot.appendChild(div);
        }
        
        dispatchSelect(event) {
            const resource = event.target.options.resource;
            this.dispatchEvent(new CustomEvent('resourceSelect', {detail: {resource: resource}}));
            if(this.next) window.dispatchEvent(new CustomEvent('navigate', {detail: {route: this.next, resource: resource}}));
        }
        appendChildElt(resource) {
            if(resource.lat && resource.lng) {
                const marker = L.marker([resource.lat, resource.lng], {resource: resource});
                marker.addTo(this.map).on('click', this.dispatchSelect.bind(this));
                this.markers.push(marker);
            }
        }
        empty() {
            for(let marker of this.markers)
                this.map.removeLayer(marker);
        }
        populate() {
            super.populate();
            this.map.fitBounds(L.featureGroup(this.markers).getBounds());
        }
    }
    customElements.define('sib-map', SIBMap);
}());
</script>
