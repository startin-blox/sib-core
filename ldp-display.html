<script type="text/javascript" src="https://cdn.happy-dev.fr/LDP-framework/ldpframework.js"></script>
<base href="https://polygit.org/components/">
<link rel="import" href="polymer/polymer-element.html">
<link rel="import" href="polymer/lib/elements/dom-repeat.html">
<link rel="import" href="polymer/lib/elements/dom-if.html">

<dom-module id="ldp-display">
    <template>
        <template is="dom-if" if="{{isContainer(resource)}}">
            <template is="dom-repeat" items="{{resource.ldp:contains}}">
                <div on-click="dispatchSelect">
                    <ldp-display resource="{{item}}"></ldp-display>
                </div>
            </template>
        </template>
        <template is="dom-if" if="{{!isContainer(resource)}}">
            <template is="dom-repeat" items="{{getFields(resource)}}">
                <div>{{getField(resource, item)}}</div>
            </template>
        </template>
    </template>

    <script>
    (function(){
        var store = new MyStore({context: "https://cdn.happy-dev.fr/owl/hdcontext.jsonld"});
        class LDPDisplay extends Polymer.Element {
            static get is() { return 'ldp-display'; }
            static get observedAttributes() {return ['data-src']; }
            getFields(resource) {
                return Object.keys(resource).filter(function(prop){return !prop.startsWith("@")});
            }
            getField(resource, field) {
                return resource[field];
            }
            dispatchSelect(event) {
                var resource = event.currentTarget.querySelector('ldp-display').resource;
                this.dispatchEvent(new CustomEvent('select', {detail: {resource: resource}}));
            }
            isContainer(resource) {
                return ('ldp:contains' in resource);
            }
            attributeChangedCallback(attribute, oldValue, newValue) {
                if(attribute == "data-src" && newValue) store.get(newValue).then(function(resource) {
                    this.resource = resource;
                }.bind(this));
            }
        }

        customElements.define(LDPDisplay.is, LDPDisplay);
    }());
    </script>
</dom-module>
