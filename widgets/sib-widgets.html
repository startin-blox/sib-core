<link rel="import" href="./sib-base-widgets.html">

<script>
    class SIBDisplayDiv extends SIBWidget {
        get template() {
            return `<div name="${this.name}">${this.value}</div>`;
        }
    }
    customElements.define("sib-display-div", SIBDisplayDiv);
    
    class SIBDisplayImg extends SIBWidget {
        get template() {
            return `<img name="${this.name}" src="${this.value}" style="max-width: 100%; max-height: 100%;"/>`;
        }
    }
    customElements.define("sib-display-img", SIBDisplayImg);
    
    class SIBDisplayList extends SIBMultipleWidget {
        get parentTag() {return "ul"}
        getTemplate(value, index) {
            return `<li id="${this.name}-${index}">${value}</li>`;
        }
    }
    customElements.define('sib-display-list', SIBDisplayList);
    
    class SIBDisplayLookupList extends SIBMultipleWidget {
        get parentTag() {return "ul"}
        getTemplate(value, index) {
            if(typeof value == "object")
                if(value.name) value = value.name;
                else {
                    store.get(value).then(resource => {
                        this.value.push(resource);
                        this.render();
                    });
                    if(Array.isArray(this.value))this.value.splice(this.value.indexOf(value), 1);
                    else this.value = [];
                    return '';
                }
            return `<li id="${this.name}-${index}">${value}</li>`;
        }
    }
    customElements.define('sib-display-lookuplist', SIBDisplayLookupList);
    
    class SIBDisplayMailTo extends SIBWidget {
        get template() {
          return `<a href="mailto:${this.value}" name="${this.name}">${this.value}</a>`;
        }
    }
    customElements.define("sib-display-mailto", SIBDisplayMailTo);
    
    class SIBDisplayTel extends SIBWidget {
        get template() {
          return `<a href="tel:${this.value}" name="${this.name}">${this.value}</a>`;
        }
    }
    customElements.define("sib-display-tel", SIBDisplayTel);
    
    
    class SIBFormText extends SIBWidget {
        get template() {
            return `<input id="id-${this.name}" placeholder="${this.label}" type="text" name="${this.name}" value='${this.value}'>`;
        }
    }
    customElements.define("sib-form-text", SIBFormText);
    
    class SIBFormLabelText extends SIBWidget {
        get template() {
            return `<label for="id-${this.name}">${this.label}</label>
                <input id="id-${this.name}" type="text" name="${this.name}" value='${this.value}'>`;
        }
    }
    customElements.define("sib-form-label-text", SIBFormLabelText);
    
    class SIBFormTextArea extends SIBWidget {
        get template() {
            return `<label for="id-${this.name}">${this.label}</label>
                <textarea id="id-${this.name}" type="text" name="${this.name}" value='${this.value}'></textarea>`;
        }
    }
    customElements.define("sib-form-textarea", SIBFormTextArea);
    
    class SIBFormCheckbox extends SIBWidget {
        get template() {
            const checked = this.value ? 'checked' : '';
            return `<label for="id-${this.name}">${this.label}</label>
                <input id="id-${this.name}" type="checkbox" name="${this.name}" ${checked}>`;
        }
    }
    customElements.define("sib-form-checkbox", SIBFormCheckbox);
    
    class SIBFormJSON extends SIBWidget {
        get template() {
            return `<label for="id-${this.name}">${this.label}</label>
                <input id="id-${this.name}" type="text" name="${this.name}" value='${JSON.stringify(this.value)}'>`;
        }
    }
    customElements.define("sib-form-json", SIBFormJSON);
    
    class SIBFormDropdown extends SIBMultipleWidget {
        get parentTag() {
            return "select";
        }
        getTemplate(item, index) {
            const selected = this.value==item['@id'] ? 'selected' : '';
            return `<option value="${JSON.stringify(item)}" ${selected}>${item.name}</option>`;
        }
        get range() {
            if(!this._range) return [];
            if(!Array.isArray(this._range)) return [this._range];
            return this._range;
        }
        set range(url) {
            store.list(url).then(list => {
                this._range = [{'@id':'','name':''}].concat(list);
                this.renderList();
                this.parent.value = this._value;
            });
        }
    }
    customElements.define("sib-form-dropdown", SIBFormDropdown);
    
    class SIBFormMultipleValue extends SIBMultipleWidget {
        getTemplate(item, index) {
            return `<div id="id-${this.name}-${index}-box" class="${this.tagName}-box">
                <input id="id-${this.name}-${index}" class="${this.tagName}-input" type="text" value='${item["@id"]}' onclick="this.closest('${this.tagName}').updateValue()">
                <button onclick="this.closest('${this.tagName}').removeField(${index});return false">x</button>
            </div>`;
        }
        appendField() {
            const index = this.querySelectorAll(`.${this.tagName}-box`).length;
            this.parent.innerHTML += this.getTemplate({}, index);
            this.updateValue();
        }
        removeField(index) {
            document.getElementById(`id-${this.name}-${index}-box`).remove();
            this.updateValue();
        }
        get appendTemplate() {
            return `<button onclick="this.closest('${this.tagName}').appendField();return false">+</button>
                <input type="hidden" id="id-${this.name}" name="${this.name}">`;
        }
        updateValue() {
            const valueList = Array.prototype.map.call(this.querySelectorAll(`.${this.tagName}-input`), input => '{"@id": "'+input.value+'"}');
            this.appendBox.querySelector('input').value = "["+valueList.join(',')+"]";
        }
        render() {
            super.render();
            this.appendBox = document.createElement('div');
            this.appendBox.innerHTML = this.appendTemplate;
            this.appendChild(this.appendBox);
            this.updateValue();
        }
    }
    customElements.define("sib-form-multiple-value", SIBFormMultipleValue);
    
    class SIBFormMultipleDropdown extends SIBFormMultipleValue {
        getTemplate(item, index) {
            return `<div id="id-${this.name}-${index}-box" class="${this.tagName}-box">
                <select id="id-${this.name}-${index}" class="${this.tagName}-input" value='${item["@id"]}' onclick="this.closest('${this.tagName}').updateValue()">
                ${this.optionList}
                </select>
                <button onclick="this.closest('${this.tagName}').removeField(${index});return false">x</button>
            </div>`;
        }
        getOptionTemplate(item) {
            return `<option value='${item["@id"]}'>${item.name}</option>`;
        }
        set range(url) {
            store.list(url).then(list => {
                this.optionList = list.map(item => this.getOptionTemplate(item)).join('');
                this.renderList();
                for(let select of this.querySelectorAll("select"))
                    select.value = select.getAttribute("value");
                this.updateValue();
            });
        }
    }
    customElements.define("sib-form-multiple-dropdown", SIBFormMultipleDropdown);
</script>
