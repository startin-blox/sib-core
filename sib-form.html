<link rel="import" href="./sib-base.html">
<link rel="import" href="widgets/sib-form-widgets.html">

<script>
(function(){
    class SIBForm extends SIBWidgetMixin(SIBBase) {
        get defaultWidget() {return 'sib-form-text';}
        
        //Special case of the dropdown
        getWidget(field) {
            if(!this.hasAttribute("widget-"+field) && this.hasAttribute("range-"+field)) return "sib-form-dropdown";
            else return super.getWidget(field);
        }
        widgetAttributes(field) {
            let attributes = super.widgetAttributes(field);
            if(this.hasAttribute("range-"+field)) attributes.range = this.getAttribute("range-"+field);
            if(this.hasAttribute("label-"+field)) attributes.label = this.getAttribute("label-"+field);
            return attributes;
        }
        
        
        //form submission handling
        formToObject(form) {
            return [].reduce.call(form.elements, function(data, element) {
                let value;
                try { value = JSON.parse(element.value)}
                catch(error) { value = element.value};
                
                if(element.name) data[element.name] = value;
                return data;
            }, {})
        }
        save(resource) {
            store.save(resource, this.resource['@id']).then(
                () => this.dispatchEvent(new CustomEvent('save', {detail: {resource: resource}}))
            );
        }
        change(resource) {
        }
        submitForm(event) {
            const resource = this.formToObject(this.form);
            if(!this.isContainer) resource['@id'] = this.resource['@id'];
            
            this.save(resource);
            
            if(this.next) window.dispatchEvent(new CustomEvent('navigate', {detail: {route: this.next, resource: resource}}));
            event.preventDefault();
            return false;
        }
        inputChange(event) {
            const resource = this.formToObject(this.form);
            if(!this.isContainer) resource['@id'] = this.resource['@id'];
            this.change(resource);
        }
        
        createInput(type) {
            const input = document.createElement('input');
            input.type = type;
            return input;
        }
        populate() {
            this.form = document.createElement('form');
            this.form.addEventListener('submit', this.submitForm.bind(this));
            this.form.addEventListener('reset', event => setTimeout(this.inputChange.bind(this)));
            this.appendChild(this.form);
            
            for(let field of this.fields)
                this.appendWidget(field, this.form);
            
            this.form.appendChild(this.createInput('submit'));
            if(this.hasAttribute('reset'))
                this.form.appendChild(this.createInput('reset'));
            
            for(let element of this.form.querySelectorAll('input, select, textarea'))
                element.addEventListener('input', this.inputChange.bind(this));
        }
    }
    
    customElements.define('sib-form', SIBForm);
}());
</script>
