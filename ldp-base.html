<script type="text/javascript" src="https://cdn.happy-dev.fr/LDP-framework/ldpframework.js"></script>

<script>
    const store = new MyStore({context: "https://cdn.happy-dev.fr/owl/hdcontext.jsonld", defaultSerializer: "application/ld+json"});
    
    class LDPBase extends HTMLElement {
        static get observedAttributes() { return ['data-fields', 'data-src', 'data-child']; }
        constructor() {
            super();
            this._filters={};
        }
        
        getWidget(field) {
            if(this.hasAttribute("widget-"+field)) {
                const widget = this.getAttribute("widget-"+field);
                if(widget.indexOf(',') == -1) return widget;
                return widget.split(',').map(s => s.trim());
            }
            return this.defaultWidget;
        }
        get fields() {
            if(this.dataset.fields) return this.dataset.fields.split(',').map(s => s.trim());
            
            const resource = this.isContainer ? this.resources[0] : this.resource;
            return Object.keys(resource).filter(prop => !prop.startsWith("@"));
        }

        isSet(field) {
            return Array.isArray(this.getWidget(field));
        }
        
        getValue(field) {
            if(this.hasAttribute("value-"+field)) return this.getAttribute("value-"+field);
            return this.resource[field];
        }
        empty() {
            while (this.firstChild) this.removeChild(this.firstChild);
        }
        appendWidget(field, parent) {
            if(!parent) parent = this;
            
            if(this.isSet(field)) {
                const div = document.createElement("div");
                div.className = field;
                parent.appendChild(div);
                for(let item of this.getWidget(field))
                    this.appendWidget(item, div);
            } else {
                const widget = document.createElement(this.getWidget(field));
                widget.value = this.getValue(field);
                widget.name = field;
                widget.className = field;
                parent.appendChild(widget);
            }
        }
        
        get filters() {
            return this._filters;
        }
        set filters(filters) {
            this._filters = filters;
            if(this.resource) this.populate();
        }
        get isContainer() {
            return ('ldp:contains' in this.resource);
        }
        listResources() {
            if(!this.isContainer) return [];
            if(Array.isArray(this.resource['ldp:contains'])) return this.resource['ldp:contains'];
            return [this.resource['ldp:contains']];
        }
        get resources() {
            return this.listResources().filter(resource => 
                Object.keys(this.filters).reduce((initial, filter) => 
                    initial && resource[filter].indexOf(this.filters[filter]) != -1
                , true)
            );
        }
        
        attributeChangedCallback(attribute, oldValue, newValue) {
            if(attribute == "data-src") {
                if(newValue) store.get(newValue).then(resource => {
                    this.resource = resource;
                    this.populate();
                });
            } else {
                if(this.resource) this.populate();
            }
        }
        connectedCallback() {
            if(this.resource) this.populate();
        }
        
    }
</script>
