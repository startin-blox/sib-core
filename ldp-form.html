<link rel="import" href="./ldp-base.html">
<link rel="import" href="./ldp-widgets.html">

<script>
(function(){
    class LDPForm extends LDPWidgetMixin(LDPBase) {
        get defaultWidget() {return 'ldp-form-text';}
        
        //Special case of the dropdown
        getWidget(field) {
            if(this.hasAttribute("range-"+field)) return "ldp-form-dropdown";
            else return super.getWidget(field);
        }
        widgetAttributes(field) {
            let attributes = super.widgetAttributes(field);
            if(this.hasAttribute("range-"+field)) attributes.range = this.getAttribute("range-"+field);
            if(this.hasAttribute("label-"+field)) attributes.label = this.getAttribute("label-"+field);
            return attributes;
        }
        
        
        //form submission handling
        formToObject(form) {
            return [].reduce.call(form.elements, function(data, element) {
                if(element.name) data[element.name] = element.value;
                return data;
            }, {})
        }
        save(resource) {
            store.save(resource, this.resource['@id']).then(
                () => this.dispatchEvent(new CustomEvent('save', {detail: {resource: resource}}))
            );
        }
        submitForm(event) {
            const resource = this.formToObject(event.target);
            if(!this.isContainer) resource['@id'] = this.resource['@id'];
            
            this.save(resource);
            
            if(this.next) window.dispatchEvent(new CustomEvent('navigate', {detail: {route: this.next, resource: resource}}));
            event.preventDefault();
            return false;
        }
        
        createInput(type) {
            const input = document.createElement('input');
            input.type = type;
            return input;
        }
        populate() {
            const form = document.createElement('form');
            form.addEventListener('submit', this.submitForm.bind(this));
            this.appendChild(form);
            
            for(let field of this.fields)
                this.appendWidget(field, form);
            
            form.appendChild(this.createInput('submit'));
            if(this.hasAttribute('reset'))
                form.appendChild(this.createInput('reset'));
        }
    }
    
    customElements.define('ldp-form', LDPForm);
}());
</script>
